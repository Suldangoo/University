# ■ 9주차 (5월 3일)

- 192.168.0.0/22 3개로 분할한 서브넷에 인스턴스와 EIP 할당 복습
- AWS 러너 랩 리셋 시 즐겨찾기 등의 메뉴는 유지, 만든 모든 리소스들이 제거됨

## 라우팅 테이블

- 기본적으로 VPC와 서브넷을 만들면 기본 라우팅 테이블이 만들어지며, 우리는 편집만 하면 됨
- 서브넷 별로 다르게 라우팅 테이블을 할당할 수 있으며, 어떤 서브넷은 인터넷에 연결하고 어떤 서브넷은 인터넷 연결을 안 할 수 있음
- 즉, 원하는 서브넷에만 인터넷 게이트 웨이를 연결하는 것이 가능

- IGW로 인터넷 연결이 **안** 되어있는 서브넷 : **Private Subnet**
- IGW로 인터넷 연결이 되어있는 서브넷 : **Public Subnet**
- 명시적 서브넷 연결 : 서브넷과 라우팅 테이블 직접 연결
- 묵시적 서브넷 연결 : 명시적 연결이 없는 경우 기본 라우팅 테이블에 연결 (기본 : 예)
    - 모든 서브넷은 기본적으로 묵시적 연결이 되어있고, 이런 경우엔 명시적 연결이 없는 서브넷 목록에 추가되어있는 모습을 확인할 수 있음.
- 기본 서브넷이라도 서브넷 - 작업 - 라우팅 테이블 연결 편집 들어가서 원하는 라우팅 테이블 할당해주면 그 서브넷은 명시적으로 연결된 것임
- 그러면 원하는 서브넷들은 IGW에 연결된 라우팅 테이블에 할당해주고, 원하는 서브넷들은 인터넷이 연결되어있지 않은 라우팅 테이블에 할당해줄 수 있음
    - 인터넷에 연결이 되어있지 않더라도 같은 VPC 내에 있는 서브넷들은 기본적으로 서로 통신 가능

- 왜 프라이빗 서브넷이 필요한가?
    - 인터넷에 연결된 장치는 항상 공격의 대상이 됨
    - 인터넷망에 직접 연결되지 않아도 되는 서버는 가급적 네트워크와 격리된 곳에 위치시키는 것이 보안 원칙
    - 연결하지 않아도 되는 서버는 전부 다 프라이빗에 몰아넣고, 인터넷 연결이 필요한 것만 퍼블릭
    - DB 서버는 백엔드 서버에선 접근이 가능하지만 인터넷으로 접근은 불가능하도록 하면 보안성 향상

- Bastion Host
    - 인터넷 게이트 웨이랑 연결되어있는 성벽 인스턴스가 퍼블릭 서브넷에 위치하고, 이 인스턴스가 프리베이트 서브넷에 있는 진짜 인스턴스로 전달해주는 2중 연결 구조로 보안성을 강화함
    - 이렇게 할 경우엔 진짜 인스턴스와 성벽 인스턴스가 서로 가용영역이 일치해야 함
    - 이럴 경우 진짜 인스턴스와 성벽 인스턴스가 같은 퍼블릭 키를 가지고 있음
    - 우리가 다운받은 ppk 프라이빗 키로 성벽 인스턴스의 퍼블릭 키와 인증하여 연결
    - 이후 성벽 인스턴스의 프라이빗 키와 진짜 인스턴스의 퍼블릭 키로 인증하여 연결

- Bastion Host로 프라이빗 서브넷 서버에 접속하는 과정
    1. 성벽 인스턴스 내에 프라이빗 키 파일을 러너랩 환경에서 복사해서 넣어두기
    
    ```bash
    scp -i ~/.ssh/labsuser.pem ~/.ssh/labsuser.pem ec2-user@성벽 인스턴스의 퍼블릭 IP:/home/ec2-user/
    ```
    
    1. 성벽 인스턴스로 접속
    
    ```bash
    ssh -i ~/.ssh/labsuser.pem ec2-user@성벽 인스턴스의 퍼블릭 IP
    ```
    
    1. 성벽 인스턴스 내에서 진짜 인스턴스로 접속
    
    ```bash
    ssh -i labsuser.pem ec2-user@진짜 인스턴스의 프라이빗 IP
    ```
    
    - 즉, 러너랩에 있던 프라이빗 키 → 성벽 인스턴스에 복사 후 이중 인증으로 연결
    - 성벽 인스턴스와 진짜 인스턴스는 같은 가용영역의 같은 VPC 내에 있으므로 프라이빗 ip로 서로 통신하게 되므로 마지막 연결은 프라이빗 ip로 해주어야 함
- 그러나 이 방법은 bastion host에 대한 SSH key를 강탈당할 경우 bastion host에 있는 키 모두 강탈당할 수 있는 위험성이 존재
- 이 절차를 손쉽게 하며 보안성이 뛰어나게 처리하는 **SSH agent forwarding** 이라는 방법이 존재

- 왜 같은 가용영역으로 설정했는가?
    - AWS에서 가용영역은 데이터 센터를 의미
    - 가용영역 간의 통신은 데이터 전송량에 따라 비용이 발생
    - 같은 가용영역이면 서브넷이 달라도 비용이 발생하지 않음
    - 즉, 베스쳔 호스트와 프라이빗 서버가 같은 가용영역에 있어야 서로 통신할 때 통신비가 발생하지 않음
    - 따라서 비용효율적으로 고가용성을 확보하는 구조를 잘 생각해서 아키텍처를 설계해야 함
        - 같은 가용영역끼리 퍼블릭과 프라이빗 서브넷을 하나씩 만들어두는 방식
        - 고가용성도 확보하고, 비용효율도 확보하는 구조

# ■ 10주차 (5월 10일)

- 퍼블릭, 프라이빗 서브넷 두 개씩 만들어 각각 인스턴스 하나씩 두고 접속하는 복습

## 인터넷과 NAT

- 공인 IP : 네트워크에서 장치를 특정하는 방법은 IP인데, IP의 개수는 한정적이고 인터넷은 거대한 하나의 IP 범위를 갖는 네트워크이다. 이를 극복하기 위한 NAT 시스템으로 대표성을 갖는 IP 하나를 가지고 인터넷과 통신할 수 있게 됨. 이 것이 공인IP
- 인터넷의 IP는 국제기구 (ICANN) 에서 관리, 총괄함.
- KISA(한국인터넷진흥원) 에서 한국의 IP 관리를 위임받아 처리
- 인터넷에 연결하기 위해서 장치들은 인터넷으로 연결되는 경로와 인터넷에서 사용할 공인 IP가 필요

- 가정에서 공유기를 통한 인터넷 연결 - NAT
    - ISP(SK, KT같은 인터넷 사업자) 에서 공유기에 공인 IP를 할당해줌
    - 공유기와 연결된 기기는 공인 IP를 받지 않았지만 NAT를 이용해 인터넷을 사용할 수 있음
        - 공유기 하나가 공인 IP를 가지고 있고 (59.232.22.32)
        - 해당 공유기가 사설 IP 범위를 지니며 (192.168.0.0/25)
        - 공유기에 연결된 기기들은 사설 IP가 부여된다 (192.168.0.4)
    - 즉, 내부 IP가지고는 인터넷의 대상들과는 통신되지 않음.
    - 따라서 공유기에 연결된 기기들은 공유기로부터 대표 IP (공인 IP) 를 빌려 인터넷을 통신함
    - 이것이 NAT의 기본
- NAT(Network Address Translation) : 공유기에서 내부에 연결된 장치들이 인터넷으로 접근할 때 공유기에 할당된 공인 IP를 이용하도록 지원
- Port(포트) : 하나의 컴퓨터에 대해서 네트워크를 사용하는 어플리케이션이 여러 개일 경우 이들을 구분하기 위한 ID 역할을 수행
    - 포트는 하나의 컴퓨터 내에서 유일하게 어플리케이션을 구분 (0~65535까지 사용 가능)
    - 한 컴퓨터는 공인IP가 하나뿐인데, 한 컴퓨터가 여러 개의 어플리케이션을 사용한다면 각 어플리케이션이 요청받은 결과를 주소만을 보는것이 아닌 포트를 포함해서 주소를 보고 결과값을 줌

- 장치 → 공유기 → 인터넷 → 공유기 → 장치 로 데이터가 순환됨
- 장치 → 공유기 → 인터넷으로 갈 땐 공인 IP를 가지고 NAT로 수행
- 인터넷 → 공유기도 해당 공인 IP로 데이터를 보내줌
- 공유기 → 장치로 데이터를 보낼 땐 NAT Table에 기록된 프라이빗IP와 포트를 보고 전달
- NAT 테이블엔 아래와 같은 내용들이 기록됨
    - 출발 장치 : 192.168.0.2:1000
    - 공유기에서 받은 포트 : 59.293.22.32:2000
    - 목적지 : 50.29.32.44:3000
- 따라서 역순으로 오더라도 동일한 IP 하나만으로 목적지를 정확히 지정해줄 수 있게 됨
- 이렇게 포트를 이용해 장치가 연결되는 것을 포워딩 (forwarding)이라고 하게 됨

- 단, 외부에서 요청을 줄 땐 노트북, 스마트폰, 컴퓨터 등의 장치에 바로 직접 접근은 불가능
- 외부는 오로지 공유기밖에 모름. 공인 IP는 공유기에만 할당되어 있으므로 특정할 수 있는 장치는 공유기뿐임
- 즉, NAT는 내부에서 외부로 나가는건 가능하지만 외부에서 내부로 오는건 불가능 (일방통행)
- 외부에서 내부로 올 땐 공유기가 포트를 사용하여 특정 대상을 집어줘야 함

## EC2 인스턴스에서의 NAT 인터넷 사용

- 실습에서 했던 프라이빗 서브넷에 가둬진 인스턴스가 이걸 사용하여 인터넷과 통신이 가능하다!
- 프라이빗 인스턴스가 NAT로부터 공인 IP를 발급받아 인터넷으로 나가는 것이 가능
- 그러나 반대로, 인터넷에서 해당 프라이빗 인스턴스로 들어올 순 없음
- 즉, 일방통행으로 나가기만 할 수 있는 것
- 이것은 NAT 게이트웨이 리소스로 실현 가능함

- NAT 게이트웨이를 생성할 수 있음
- 그러나 이것은 인터넷 게이트웨이처럼 VPC에 할당하는 것이 아닌, 서브넷에 할당하는 것
- 어떤 서브넷에 NAT 게이트웨이를 생성할지 지정해주어야함. 그런 어떤 서브넷에?
- 반드시 **Public 서브넷**에 만들어주어야 함!
    - 프라이빗 인스턴스가 쓸 것이지만, NAT 게이트웨이 자체는 인터넷과 통신 가능해야 함
- 연결 유형은 퍼블릭으로 지정
    - 인터넷으로 연결한다는 것. 프라이빗으로 할 경우 다른 프라이빗 네트워크와 연결한다는 의미
- 탄력적 IP를 할당받아야 함. 여기서 EIP를 직접 생성해서 하지 않아도 버튼 하나로 바로 EIP를 할당받을 수 있음

- 이제 이 NAT 게이트웨이를 프라이빗 서브넷에 규칙으로 추가해주어야 함
- 프라이빗 서브넷으로 가서 라우팅 편집 → 0.0.0.0/0 을 NAT 게이트웨이 대상으로 규칙 추가
- 이러면 퍼블릭 → 인터넷 게이트웨이, 프라이빗 → NAT 게이트웨이 연결이 성립됨
- 이제 프라이빗 인스턴스에 접속해서 ping으로 인터넷에 연결확인이 가능함

## 보안 그룹 : 네트워크에 대한 접근 제어

- 인터넷에 노출된 이상 브루트포스 해킹으로 무작위 비밀번호 대입에 대한 공격이 이루어질 수 있음
- 또한 요청을 마구잡이로 넣어 트래픽이 초과되는 D-DOS 공격도 이루어질 수 있음
- 이런 사항들을 대비해서 보안을 쳐두는 것이 보안 그룹에서 이루어짐

- 보안 그룹 (Security Gruop)을 통해 EC2 인스턴스에 접근 가능한 네트워크 영역을 제한
    - 아웃바운드 / 인바운드 규칙을 통해 들어오고 나가는 트래픽을 제어
        - 트래픽 : 네트워크를 통해 교환되는 패킷의 흐름
        - 패킷 : 네트워크를 통해 장치 간에 교환되는 데이터
- EC2 인스턴스에서 아웃바운드 규칙에 따라 네트워크로 연결된 장치로 이동
    - 아웃바운드 규칙이 다른 장치로 나가는 패킷을 제어
- 외부 장치가 인바운드 규칙에 따라 EC2 인스턴스로 이동
    - 인바운드 규칙이 다른 장치에서 EC2 인스턴스로 들어오는 패킷을 제어
- 즉, 안에서 밖으로 나가거나 밖에서 안으로 들어올 때 바로 나가는 것이 아닌 보안 그룹에서 한번 아웃바운드나 인바운드 규칙에서 체크를 하고 위배된다면 비허용, 괜찮다면 허용해주는 것

- 아웃바운드와 인바운드에 아무런 규칙이 없다면 어떤 트래픽도 허용되지 않음
- 아웃바운드 규칙에서 EC2 인스턴스에서 접근하는 외부의 네트워크 대역 설정
- 인바운드 규칙에서 EC2 인스턴스로 접근할 수 있는 외부의 네트워크 대역 설정
    - 예를 들어 0.0.0.0/0 을 허용하면 외부로 나가는 모든 트래픽 허용
    - 그러나 192.168.0.0/24 만을 허용하면 해당 대역으로만 트래픽 허용
    - 하나의 IP하고만 통신하고 싶다면 196.10.0.8/32

- 중요한 점으로, 아웃바운드가 허용된 곳으로 보낸 요청에 대한 응답은 인바운드 규칙과 상관 없이 반드시 허용
    - 인바운드 규칙이 지정한 대역이 아닌 곳이어도, 우리의 아웃바운드 규칙에 따라 우리가 먼저 요청을 보내고 그에 대한 응답이 온 것이라면 허용시켜준다.
- 단, 외부에서 시작된 요청은 인바운드 규칙에 의해 통제됨
- 어디서 먼저 시작했느냐가 매우 중요

- 우리는 AWS 아카데미 실습 환경용 서버 → EC2 인스턴스로 원격 접속을 할 것임
- NAT 게이트 웨이가 가지고 있는 Public IP 를 확인하는 명령어
    - curl [https://check](https://check)ip.amazonaws.com
- 위 명령어로 우리 AWS 아카데미 실습 환경용 서버의 NAT 게이트웨이 공인 IP를 볼 수 있음
- 우리는 EC2 인스턴스의 보안 그룹 규칙을 수정하여 나의 러너랩 터미널에서만 접근할 수 있도록 접근제어를 할 것임

1. 러너 랩의 NAT 게이트 웨이가 가지고있는 퍼블릭 IP를 알아둔다
2. Bastion Host용 인스턴스에 등록되어있는 보안 그룹을 찾는다
3. 해당 보안 그룹의 이름을 bastion으로 수정한다
4. 해당 보안 그룹의 인바운드 규칙을 편집한다
5. SSH 서버 (포트번호 22) 에서 0.0.0.0/0 이 아닌 알아둔 러너랩 퍼블릭 IP/32 로 지정한다
6. 이러면 인바운드 규칙은 대역 하나로 고정, 아웃바운드 규칙은 0.0.0.0/0 으로 오픈되어있다

- 이러면 Bastion Host로 들어가는 것은 러너랩 환경으로 고정되어있다
- 이제 진짜 EC2 인스턴스로 들어가는 인바운드 규칙을 로컬 영역에서만 접근할 수 있도록 (동일한 VPC 내에서만) 인바운드 규칙을 설정해줄 것이다
- 물론 둘 다 아웃바운드 규칙은 0.0.0.0/0:ALL 로 전부 오픈이다

1. 이번엔 보안 그룹을 직접 생성해서 할당해주는 것도 해볼 것이다
2. 보안 그룹을 생성한다
3. 보안 그룹의 이름을 짓고, 설명도 작성한다
4. VPC는 우리가 만든 인스턴스가 있는 VPC로 지정해준다
5. 인바운드 규칙을 추가한다
6. 사용자 지정 TCP 유형에서 우선은 포트 범위를 22로만 두어 SSH만 허용하도록 작성
7. 접근 가능한 IP CIDR를 내 VPC 범위와 똑같이 작성
8. 태그도 직접 추가
9. 보안그룹을 생성했다면 인스턴스 화면으로 가 기존의 private 인스턴스를 선택
10. 작업 - 보안 - 보안 그룹 변경을 눌러 기존의 보안 그룹을 제거하고 방금 만든 보안 그룹을 추가

- 이렇게 되면 해당 private 서버엔 같은 VPC에서만 접근하도록 설정이 됨
- 보안 그룹 당 기본 인바운드 60, 아웃바운드 60, 총 120개의 규칙을 지정 가능 (증량 가능)
- 네트워크 인터페이스 당 기본 5개, 최대 16개의 보안 그룹 지정 가능
    - 보안 그룹을 여러 개 사용 가능하다는 의미이다