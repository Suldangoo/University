# ■ 9주차 (5월 3일)

- 192.168.0.0/22 3개로 분할한 서브넷에 인스턴스와 EIP 할당 복습
- AWS 러너 랩 리셋 시 즐겨찾기 등의 메뉴는 유지, 만든 모든 리소스들이 제거됨

## 라우팅 테이블

- 기본적으로 VPC와 서브넷을 만들면 기본 라우팅 테이블이 만들어지며, 우리는 편집만 하면 됨
- 서브넷 별로 다르게 라우팅 테이블을 할당할 수 있으며, 어떤 서브넷은 인터넷에 연결하고 어떤 서브넷은 인터넷 연결을 안 할 수 있음
- 즉, 원하는 서브넷에만 인터넷 게이트 웨이를 연결하는 것이 가능

- IGW로 인터넷 연결이 **안** 되어있는 서브넷 : **Private Subnet**
- IGW로 인터넷 연결이 되어있는 서브넷 : **Public Subnet**
- 명시적 서브넷 연결 : 서브넷과 라우팅 테이블 직접 연결
- 묵시적 서브넷 연결 : 명시적 연결이 없는 경우 기본 라우팅 테이블에 연결 (기본 : 예)
    - 모든 서브넷은 기본적으로 묵시적 연결이 되어있고, 이런 경우엔 명시적 연결이 없는 서브넷 목록에 추가되어있는 모습을 확인할 수 있음.
- 기본 서브넷이라도 서브넷 - 작업 - 라우팅 테이블 연결 편집 들어가서 원하는 라우팅 테이블 할당해주면 그 서브넷은 명시적으로 연결된 것임
- 그러면 원하는 서브넷들은 IGW에 연결된 라우팅 테이블에 할당해주고, 원하는 서브넷들은 인터넷이 연결되어있지 않은 라우팅 테이블에 할당해줄 수 있음
    - 인터넷에 연결이 되어있지 않더라도 같은 VPC 내에 있는 서브넷들은 기본적으로 서로 통신 가능

- 왜 프라이빗 서브넷이 필요한가?
    - 인터넷에 연결된 장치는 항상 공격의 대상이 됨
    - 인터넷망에 직접 연결되지 않아도 되는 서버는 가급적 네트워크와 격리된 곳에 위치시키는 것이 보안 원칙
    - 연결하지 않아도 되는 서버는 전부 다 프라이빗에 몰아넣고, 인터넷 연결이 필요한 것만 퍼블릭
    - DB 서버는 백엔드 서버에선 접근이 가능하지만 인터넷으로 접근은 불가능하도록 하면 보안성 향상

- Bastion Host
    - 인터넷 게이트 웨이랑 연결되어있는 성벽 인스턴스가 퍼블릭 서브넷에 위치하고, 이 인스턴스가 프리베이트 서브넷에 있는 진짜 인스턴스로 전달해주는 2중 연결 구조로 보안성을 강화함
    - 이렇게 할 경우엔 진짜 인스턴스와 성벽 인스턴스가 서로 가용영역이 일치해야 함
    - 이럴 경우 진짜 인스턴스와 성벽 인스턴스가 같은 퍼블릭 키를 가지고 있음
    - 우리가 다운받은 ppk 프라이빗 키로 성벽 인스턴스의 퍼블릭 키와 인증하여 연결
    - 이후 성벽 인스턴스의 프라이빗 키와 진짜 인스턴스의 퍼블릭 키로 인증하여 연결

- Bastion Host로 프라이빗 서브넷 서버에 접속하는 과정
    1. 성벽 인스턴스 내에 프라이빗 키 파일을 러너랩 환경에서 복사해서 넣어두기
    
    ```bash
    scp -i ~/.ssh/labsuser.pem ~/.ssh/labsuser.pem ec2-user@성벽 인스턴스의 퍼블릭 IP:/home/ec2-user/
    ```
    
    1. 성벽 인스턴스로 접속
    
    ```bash
    ssh -i ~/.ssh/labsuser.pem ec2-user@성벽 인스턴스의 퍼블릭 IP
    ```
    
    1. 성벽 인스턴스 내에서 진짜 인스턴스로 접속
    
    ```bash
    ssh -i labsuser.pem ec2-user@진짜 인스턴스의 프라이빗 IP
    ```
    
    - 즉, 러너랩에 있던 프라이빗 키 → 성벽 인스턴스에 복사 후 이중 인증으로 연결
    - 성벽 인스턴스와 진짜 인스턴스는 같은 가용영역의 같은 VPC 내에 있으므로 프라이빗 ip로 서로 통신하게 되므로 마지막 연결은 프라이빗 ip로 해주어야 함
- 그러나 이 방법은 bastion host에 대한 SSH key를 강탈당할 경우 bastion host에 있는 키 모두 강탈당할 수 있는 위험성이 존재
- 이 절차를 손쉽게 하며 보안성이 뛰어나게 처리하는 **SSH agent forwarding** 이라는 방법이 존재

- 왜 같은 가용영역으로 설정했는가?
    - AWS에서 가용영역은 데이터 센터를 의미
    - 가용영역 간의 통신은 데이터 전송량에 따라 비용이 발생
    - 같은 가용영역이면 서브넷이 달라도 비용이 발생하지 않음
    - 즉, 베스쳔 호스트와 프라이빗 서버가 같은 가용영역에 있어야 서로 통신할 때 통신비가 발생하지 않음
    - 따라서 비용효율적으로 고가용성을 확보하는 구조를 잘 생각해서 아키텍처를 설계해야 함
        - 같은 가용영역끼리 퍼블릭과 프라이빗 서브넷을 하나씩 만들어두는 방식
        - 고가용성도 확보하고, 비용효율도 확보하는 구조